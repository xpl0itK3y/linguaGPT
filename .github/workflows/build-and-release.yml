name: Build and Release

on:
  push:
    tags:
      - "v*.*.*"
  workflow_dispatch:

jobs:
  build:
    name: Build for ${{ matrix.os }}
    runs-on: ${{ matrix.os }}

    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
      fail-fast: false

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: "pip"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Install Linux dependencies (Qt6)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y libxcb-xinerama0 libxcb-randr0 libxcb-xtest0 libxcb-shape0 libxcb-xkb1 libxcb-icccm4 libxcb-image0 libxcb-keysyms1 libxcb-render-util0 libxkbcommon-x11-0 libx11-6 libx11-xcb1 libfontconfig1 libfreetype6 libdbus-1-3 libgl1 libglx-mesa0 libegl1 libqt6core6 libqt6gui6 libqt6widgets6 libqt6network6 libqt6printsupport6 libqt6svg6 qt6-base-dev-tools

      - name: Build application (Linux/macOS)
        if: runner.os != 'Windows'
        run: python build.py
        env:
          GITHUB_ACTIONS: true
          QT_QPA_PLATFORM: offscreen

      - name: Build application (Windows)
        if: runner.os == 'Windows'
        run: python build.py
        env:
          GITHUB_ACTIONS: true

      # ===== PACKAGING =====

      - name: Package Linux
        if: runner.os == 'Linux'
        run: |
          # Create DEB package structure
          mkdir -p packaging/deb/DEBIAN
          mkdir -p packaging/deb/usr/bin
          mkdir -p packaging/deb/usr/share/applications
          mkdir -p packaging/deb/usr/share/icons/hicolor/256x256/apps

          # Copy executable
          cp dist/LinguaGPT packaging/deb/usr/bin/
          chmod +x packaging/deb/usr/bin/LinguaGPT

          # Get version from tag
          VERSION="${GITHUB_REF#refs/tags/v}"

          # Create control file
          cat > packaging/deb/DEBIAN/control << EOFCONTROL
          Package: linguagpt
          Version: ${VERSION}
          Section: utils
          Priority: optional
          Architecture: amd64
          Maintainer: LinguaGPT Team <support@linguagpt.com>
          Depends: libqt6core6t64, libqt6gui6t64, libqt6widgets6t64, libqt6network6t64, libqt6printsupport6t64, libqt6svg6, libqt6dbus6t64, libstdc++6, libc6
          Description: AI-powered translation tool
           LinguaGPT is a modern translation application powered by GPT models.
           It provides high-quality translations using OpenAI's API.
          EOFCONTROL

          # Create desktop entry
          cat > packaging/deb/usr/share/applications/linguagpt.desktop << EOFDESKTOP
          [Desktop Entry]
          Name=LinguaGPT
          Comment=AI-powered translation tool
          Exec=/usr/bin/LinguaGPT
          Icon=linguagpt
          Terminal=false
          Type=Application
          Categories=Utility;Office;Translation;
          EOFDESKTOP

          # Build DEB package
          dpkg-deb --build packaging/deb
          mv packaging/deb.deb "linguagpt_${VERSION}_amd64.deb"

          # Also create standalone executable
          chmod +x dist/LinguaGPT
          cp dist/LinguaGPT LinguaGPT

          # Create AppImage
          echo "=== Creating AppImage ==="
          mkdir -p packaging/AppImage/AppDir/usr/bin
          mkdir -p packaging/AppImage/AppDir/usr/share/applications
          mkdir -p packaging/AppImage/AppDir/usr/share/icons/hicolor/256x256/apps

          # Copy executable
          cp dist/LinguaGPT packaging/AppImage/AppDir/usr/bin/
          chmod +x packaging/AppImage/AppDir/usr/bin/LinguaGPT

          # Create AppRun script
          cat > packaging/AppImage/AppDir/AppRun << 'EOFAPPRUN'
          #!/bin/bash
          SELF=$(readlink -f "$0")
          HERE=${SELF%/*}
          export PATH="${HERE}/usr/bin:${HERE}/usr/sbin:${PATH}"
          export LD_LIBRARY_PATH="${HERE}/usr/lib:${HERE}/usr/lib/x86_64-linux-gnu:${LD_LIBRARY_PATH}"
          export QTC_PLUGIN_PATH="${HERE}/usr/plugins"
          exec "${HERE}/usr/bin/LinguaGPT" "$@"
          EOFAPPRUN
          chmod +x packaging/AppImage/AppDir/AppRun

          # Create desktop file
          cat > packaging/AppImage/AppDir/linguagpt.desktop << 'EOFDESKTOP'
          [Desktop Entry]
          Name=LinguaGPT
          Comment=AI-powered translation tool
          Exec=LinguaGPT
          Icon=linguagpt
          Terminal=false
          Type=Application
          Categories=Utility;Office;Translation;
          EOFDESKTOP

          # Install ImageMagick for icon creation
          sudo apt-get install -y imagemagick

          # Create simple icon (16x16 PNG)
          convert -size 256x256 xc:#4A90E2 -gravity center -pointsize 72 -annotate +0+0 "LG" packaging/AppImage/AppDir/linguagpt.png

          # Install FUSE for AppImage
          sudo apt-get install -y fuse libfuse2

          # Download AppImageTool
          wget -q https://github.com/AppImage/AppImageKit/releases/download/continuous/appimagetool-x86_64.AppImage -O appimagetool
          chmod +x appimagetool

          # Verify AppDir structure
          echo "=== AppDir structure ==="
          find packaging/AppImage/AppDir -type f -ls

          # Create AppImage
          echo "=== Running appimagetool ==="
          ./appimagetool --no-appstream packaging/AppImage/AppDir LinguaGPT-${VERSION}-x86_64.AppImage
          if [ $? -ne 0 ]; then
            echo "❌ AppImage creation failed!"
            echo "Exit code: $?"
            echo "AppDir contents:"
            ls -la packaging/AppImage/AppDir/
            ls -la packaging/AppImage/AppDir/usr/bin/
          fi

          # Copy AppImage to root
          if [ -f "LinguaGPT-${VERSION}-x86_64.AppImage" ]; then
            cp LinguaGPT-${VERSION}-x86_64.AppImage LinguaGPT.AppImage
            echo "✅ AppImage created successfully"
          else
            echo "❌ AppImage file not found"
          fi

      - name: Package macOS
        if: runner.os == 'macOS'
        run: |
          VERSION="${GITHUB_REF#refs/tags/v}"

          # Install create-dmg if available
          brew install create-dmg 2>/dev/null || true

          # Create DMG
          if command -v create-dmg &> /dev/null; then
            create-dmg \
              --volname "LinguaGPT" \
              --volicon "dist/LinguaGPT.app/Contents/Resources/icon.icns" \
              --window-pos 200 120 \
              --window-size 600 400 \
              --icon-size 100 \
              --icon "LinguaGPT.app" 175 120 \
              --hide-extension "LinguaGPT.app" \
              --app-drop-link 425 120 \
              "LinguaGPT-${VERSION}.dmg" \
              "dist/LinguaGPT.app" || \
            hdiutil create -volname "LinguaGPT" \
              -srcfolder "dist/LinguaGPT.app" \
              -ov -format UDZO \
              "LinguaGPT-${VERSION}.dmg"
          else
            hdiutil create -volname "LinguaGPT" \
              -srcfolder "dist/LinguaGPT.app" \
              -ov -format UDZO \
              "LinguaGPT-${VERSION}.dmg"
          fi

          # Create ZIP with .app
          cd dist
          zip -r ../LinguaGPT.app.zip LinguaGPT.app
          cd ..

      - name: Package Windows
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          # Create portable ZIP
          Compress-Archive -Path "dist\LinguaGPT.exe" -DestinationPath "LinguaGPT.exe.zip" -Force

          # Copy standalone exe
          Copy-Item "dist\LinguaGPT.exe" -Destination "LinguaGPT.exe"

          # Try to create installer with Inno Setup (if available)
          $innoSetup = "C:\Program Files (x86)\Inno Setup 6\ISCC.exe"
          if (Test-Path $innoSetup) {
            # Create Inno Setup script
            $version = $env:GITHUB_REF -replace 'refs/tags/v', ''

            @"
          [Setup]
          AppName=LinguaGPT
          AppVersion=$version
          DefaultDirName={pf}\LinguaGPT
          DefaultGroupName=LinguaGPT
          OutputDir=.
          OutputBaseFilename=LinguaGPT-Setup-$version
          Compression=lzma2
          SolidCompression=yes

          [Files]
          Source: "dist\LinguaGPT.exe"; DestDir: "{app}"

          [Icons]
          Name: "{group}\LinguaGPT"; Filename: "{app}\LinguaGPT.exe"
          Name: "{commondesktop}\LinguaGPT"; Filename: "{app}\LinguaGPT.exe"
          "@ | Out-File -FilePath "installer.iss" -Encoding UTF8

            & $innoSetup "installer.iss"
          }

      # ===== UPLOAD ARTIFACTS =====

      - name: Upload Linux artifacts
        if: runner.os == 'Linux'
        uses: actions/upload-artifact@v4
        with:
          name: linux-artifacts
          path: |
            LinguaGPT
            linguagpt_*_amd64.deb
            LinguaGPT.AppImage
          retention-days: 7

      - name: Upload macOS artifacts
        if: runner.os == 'macOS'
        uses: actions/upload-artifact@v4
        with:
          name: macos-artifacts
          path: |
            LinguaGPT-*.dmg
            LinguaGPT.app.zip
          retention-days: 7

      - name: Upload Windows artifacts
        if: runner.os == 'Windows'
        uses: actions/upload-artifact@v4
        with:
          name: windows-artifacts
          path: |
            LinguaGPT.exe
            LinguaGPT.exe.zip
            LinguaGPT-Setup-*.exe
          retention-days: 7

  release:
    name: Create Release
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Extract version from tag
        id: get_version
        run: |
          VERSION="${GITHUB_REF#refs/tags/v}"
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Extracted version: $VERSION"

      - name: List all downloaded files
        run: |
          echo "=== All downloaded artifacts ==="
          find artifacts -type f -ls

      - name: Prepare release files
        run: |
          mkdir -p release

          echo "=== Copying Linux files ==="
          if [ -f "artifacts/linux-artifacts/LinguaGPT" ]; then
            cp artifacts/linux-artifacts/LinguaGPT release/
            echo "✅ Copied LinguaGPT executable"
          fi

          if ls artifacts/linux-artifacts/linguagpt_*_amd64.deb 1> /dev/null 2>&1; then
            cp artifacts/linux-artifacts/linguagpt_*_amd64.deb release/
            echo "✅ Copied .deb package"
          fi

          if [ -f "artifacts/linux-artifacts/LinguaGPT.AppImage" ]; then
            cp artifacts/linux-artifacts/LinguaGPT.AppImage release/
            echo "✅ Copied AppImage"
          fi

          echo "=== Copying macOS files ==="
          if ls artifacts/macos-artifacts/LinguaGPT-*.dmg 1> /dev/null 2>&1; then
            cp artifacts/macos-artifacts/LinguaGPT-*.dmg release/
            echo "Copied .dmg file"
          fi

          if [ -f artifacts/macos-artifacts/LinguaGPT.app.zip ]; then
            cp artifacts/macos-artifacts/LinguaGPT.app.zip release/
            echo "Copied .app.zip"
          fi

          echo "=== Copying Windows files ==="
          if [ -f artifacts/windows-artifacts/LinguaGPT.exe ]; then
            cp artifacts/windows-artifacts/LinguaGPT.exe release/
            echo "Copied .exe file"
          fi

          if [ -f artifacts/windows-artifacts/LinguaGPT.exe.zip ]; then
            cp artifacts/windows-artifacts/LinguaGPT.exe.zip release/
            echo "Copied portable ZIP"
          fi

          if ls artifacts/windows-artifacts/LinguaGPT-Setup-*.exe 1> /dev/null 2>&1; then
            cp artifacts/windows-artifacts/LinguaGPT-Setup-*.exe release/
            echo "Copied installer"
          fi

          echo "=== Final release files ==="
          ls -lah release/

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: release/*
          name: LinguaGPT v${{ steps.get_version.outputs.version }}
          body: |
            ## Downloads

            **Windows**
            - `LinguaGPT-Setup-*.exe` (Installer)
            - `LinguaGPT.exe` (Portable)
            - `LinguaGPT.exe.zip` (ZIP)

            **macOS**
            - `LinguaGPT-*.dmg` (DMG)
            - `LinguaGPT.app.zip` (App Bundle)

            **Linux**
            - `linguagpt_*_amd64.deb` (DEB Package)
            - `LinguaGPT` (Executable)
            - `LinguaGPT.AppImage` (Universal)
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

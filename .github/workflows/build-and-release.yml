name: Build and Release

on:
  push:
    tags:
      - "v*.*.*"
  workflow_dispatch:

jobs:
  build:
    name: Build for ${{ matrix.os }}
    runs-on: ${{ matrix.os }}

    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
      fail-fast: false

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: "pip"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Install Linux dependencies (Qt6)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y libxcb-xinerama0 libxcb-randr0 libxcb-xtest0 libxcb-shape0 libxcb-xkb1 libxcb-icccm4 libxcb-image0 libxcb-keysyms1 libxcb-render-util0 libxkbcommon-x11-0 libx11-6 libx11-xcb1 libfontconfig1 libfreetype6 libdbus-1-3 libgl1 libglx-mesa0 libegl1 libqt6core6 libqt6gui6 libqt6widgets6 libqt6network6 libqt6printsupport6 libqt6svg6 qt6-base-dev-tools

      - name: Build application (Linux/macOS)
        if: runner.os != 'Windows'
        run: python build.py
        env:
          GITHUB_ACTIONS: true
          QT_QPA_PLATFORM: offscreen

      - name: Build application (Windows)
        if: runner.os == 'Windows'
        run: python build.py
        env:
          GITHUB_ACTIONS: true

      # ===== PACKAGING =====

      - name: Package Linux
        if: runner.os == 'Linux'
        run: |
          VERSION="${GITHUB_REF#refs/tags/v}"

          # Install packaging tools
          sudo apt-get install -y imagemagick fuse libfuse2 rpm

          # Create icon (used by all packages)
          convert -size 256x256 xc:#4A90E2 -gravity center -pointsize 72 -annotate +0+0 "LG" linguagpt-icon.png

          # ========================================
          # 1. DEB Package (Debian/Ubuntu/Mint)
          # ========================================
          echo "=== Creating DEB package ==="
          mkdir -p packaging/deb/DEBIAN
          mkdir -p packaging/deb/usr/bin
          mkdir -p packaging/deb/usr/share/applications
          mkdir -p packaging/deb/usr/share/icons/hicolor/256x256/apps

          cp dist/LinguaGPT packaging/deb/usr/bin/
          chmod +x packaging/deb/usr/bin/LinguaGPT
          cp linguagpt-icon.png packaging/deb/usr/share/icons/hicolor/256x256/apps/linguagpt.png

          cat > packaging/deb/DEBIAN/control << EOFCONTROL
          Package: linguagpt
          Version: ${VERSION}
          Section: utils
          Priority: optional
          Architecture: amd64
          Maintainer: LinguaGPT Team <support@linguagpt.com>
          Depends: libqt6core6t64, libqt6gui6t64, libqt6widgets6t64, libqt6network6t64, libqt6printsupport6t64, libqt6svg6, libqt6dbus6t64, libstdc++6, libc6
          Description: AI-powered translation tool
           LinguaGPT is a modern translation application powered by GPT models.
           It provides high-quality translations using OpenAI's API.
          EOFCONTROL

          cat > packaging/deb/usr/share/applications/linguagpt.desktop << EOFDESKTOP
          [Desktop Entry]
          Name=LinguaGPT
          Comment=AI-powered translation tool
          Exec=/usr/bin/LinguaGPT
          Icon=linguagpt
          Terminal=false
          Type=Application
          Categories=Utility;Office;Translation;
          EOFDESKTOP

          dpkg-deb --build packaging/deb
          mv packaging/deb.deb "linguagpt_${VERSION}_amd64.deb"

          # ========================================
          # 2. RPM Package (Fedora/RHEL/CentOS/Rocky)
          # ========================================
          echo "=== Creating RPM package ==="
          mkdir -p ~/rpmbuild/{BUILD,RPMS,SOURCES,SPECS,SRPMS}
          mkdir -p packaging/rpm/linguagpt-${VERSION}
          mkdir -p packaging/rpm/linguagpt-${VERSION}/usr/bin
          mkdir -p packaging/rpm/linguagpt-${VERSION}/usr/share/applications
          mkdir -p packaging/rpm/linguagpt-${VERSION}/usr/share/icons/hicolor/256x256/apps

          cp dist/LinguaGPT packaging/rpm/linguagpt-${VERSION}/usr/bin/
          chmod +x packaging/rpm/linguagpt-${VERSION}/usr/bin/LinguaGPT
          cp linguagpt-icon.png packaging/rpm/linguagpt-${VERSION}/usr/share/icons/hicolor/256x256/apps/linguagpt.png

          cat > packaging/rpm/linguagpt-${VERSION}/usr/share/applications/linguagpt.desktop << EOFDESKTOP
          [Desktop Entry]
          Name=LinguaGPT
          Comment=AI-powered translation tool
          Exec=/usr/bin/LinguaGPT
          Icon=linguagpt
          Terminal=false
          Type=Application
          Categories=Utility;Office;Translation;
          EOFDESKTOP

          cd packaging/rpm
          tar czf ~/rpmbuild/SOURCES/linguagpt-${VERSION}.tar.gz linguagpt-${VERSION}
          cd ../..

          cat > ~/rpmbuild/SPECS/linguagpt.spec << EOFSPEC
          Name:           linguagpt
          Version:        ${VERSION}
          Release:        1%{?dist}
          Summary:        AI-powered translation tool
          License:        MIT
          URL:            https://github.com/yourusername/linguagpt
          Source0:        %{name}-%{version}.tar.gz

          BuildRequires:  coreutils
          Requires:       qt6-qtbase, qt6-qtsvg

          %description
          LinguaGPT is a modern translation application powered by GPT models.
          It provides high-quality translations using OpenAI's API.

          %prep
          %setup -q

          %install
          rm -rf %{buildroot}
          mkdir -p %{buildroot}/usr/bin
          mkdir -p %{buildroot}/usr/share/applications
          mkdir -p %{buildroot}/usr/share/icons/hicolor/256x256/apps
          cp -a * %{buildroot}/

          %files
          %attr(0755, root, root) /usr/bin/LinguaGPT
          /usr/share/applications/linguagpt.desktop
          /usr/share/icons/hicolor/256x256/apps/linguagpt.png

          %changelog
          * $(date "+%a %b %d %Y") LinguaGPT Team <support@linguagpt.com> - ${VERSION}-1
          - Release version ${VERSION}
          EOFSPEC

          rpmbuild -bb ~/rpmbuild/SPECS/linguagpt.spec
          cp ~/rpmbuild/RPMS/x86_64/linguagpt-${VERSION}-1.*.x86_64.rpm .

          # ========================================
          # 3. Arch Linux Package (PKGBUILD + tarball)
          # ========================================
          echo "=== Creating Arch Linux package ==="
          mkdir -p packaging/arch

          cat > packaging/arch/PKGBUILD << 'EOFPKG'
          # Maintainer: LinguaGPT Team <support@linguagpt.com>
          pkgname=linguagpt
          pkgver=VERSION_PLACEHOLDER
          pkgrel=1
          pkgdesc="AI-powered translation tool"
          arch=('x86_64')
          url="https://github.com/yourusername/linguagpt"
          license=('MIT')
          depends=('qt6-base' 'qt6-svg')
          source=("linguagpt-${pkgver}.tar.gz")
          sha256sums=('SKIP')

          package() {
              install -Dm755 "${srcdir}/LinguaGPT" "${pkgdir}/usr/bin/LinguaGPT"
              install -Dm644 "${srcdir}/linguagpt.desktop" "${pkgdir}/usr/share/applications/linguagpt.desktop"
              install -Dm644 "${srcdir}/linguagpt.png" "${pkgdir}/usr/share/icons/hicolor/256x256/apps/linguagpt.png"
          }
          EOFPKG

          sed -i "s/VERSION_PLACEHOLDER/${VERSION}/g" packaging/arch/PKGBUILD

          # Create tarball for Arch
          mkdir -p packaging/arch/linguagpt-${VERSION}
          cp dist/LinguaGPT packaging/arch/linguagpt-${VERSION}/
          cp linguagpt-icon.png packaging/arch/linguagpt-${VERSION}/linguagpt.png

          cat > packaging/arch/linguagpt-${VERSION}/linguagpt.desktop << EOFDESKTOP
          [Desktop Entry]
          Name=LinguaGPT
          Comment=AI-powered translation tool
          Exec=/usr/bin/LinguaGPT
          Icon=linguagpt
          Terminal=false
          Type=Application
          Categories=Utility;Office;Translation;
          EOFDESKTOP

          cd packaging/arch
          tar czf linguagpt-${VERSION}.tar.gz linguagpt-${VERSION}/
          cd ../..

          # Create installation package
          mkdir -p linguagpt-arch-${VERSION}
          cp packaging/arch/PKGBUILD linguagpt-arch-${VERSION}/
          cp packaging/arch/linguagpt-${VERSION}.tar.gz linguagpt-arch-${VERSION}/

          cat > linguagpt-arch-${VERSION}/INSTALL.txt << EOFINSTALL
          # LinguaGPT Installation for Arch Linux

          ## Installation:
          1. cd linguagpt-arch-${VERSION}
          2. makepkg -si

          ## Or use the AUR helper:
          yay -S linguagpt
          # or
          paru -S linguagpt

          ## Manual installation:
          sudo pacman -U linguagpt-${VERSION}-1-x86_64.pkg.tar.zst
          EOFINSTALL

          tar czf linguagpt-arch-${VERSION}.tar.gz linguagpt-arch-${VERSION}/

          # ========================================
          # 4. AppImage (Universal Linux)
          # ========================================
          echo "=== Creating AppImage ==="
          mkdir -p packaging/AppImage/AppDir/usr/bin
          mkdir -p packaging/AppImage/AppDir/usr/share/applications
          mkdir -p packaging/AppImage/AppDir/usr/share/icons/hicolor/256x256/apps

          cp dist/LinguaGPT packaging/AppImage/AppDir/usr/bin/
          chmod +x packaging/AppImage/AppDir/usr/bin/LinguaGPT
          cp linguagpt-icon.png packaging/AppImage/AppDir/usr/share/icons/hicolor/256x256/apps/linguagpt.png
          cp linguagpt-icon.png packaging/AppImage/AppDir/linguagpt.png

          cat > packaging/AppImage/AppDir/AppRun << 'EOFAPPRUN'
          #!/bin/bash
          SELF=$(readlink -f "$0")
          HERE=${SELF%/*}
          export PATH="${HERE}/usr/bin:${HERE}/usr/sbin:${PATH}"
          export LD_LIBRARY_PATH="${HERE}/usr/lib:${HERE}/usr/lib/x86_64-linux-gnu:${LD_LIBRARY_PATH}"
          export QTC_PLUGIN_PATH="${HERE}/usr/plugins"
          exec "${HERE}/usr/bin/LinguaGPT" "$@"
          EOFAPPRUN
          chmod +x packaging/AppImage/AppDir/AppRun

          cat > packaging/AppImage/AppDir/linguagpt.desktop << 'EOFDESKTOP'
          [Desktop Entry]
          Name=LinguaGPT
          Comment=AI-powered translation tool
          Exec=LinguaGPT
          Icon=linguagpt
          Terminal=false
          Type=Application
          Categories=Utility;Office;Translation;
          EOFDESKTOP

          wget -q https://github.com/AppImage/AppImageKit/releases/download/continuous/appimagetool-x86_64.AppImage -O appimagetool
          chmod +x appimagetool

          ARCH=x86_64 ./appimagetool --no-appstream packaging/AppImage/AppDir LinguaGPT-${VERSION}-x86_64.AppImage

          if [ -f "LinguaGPT-${VERSION}-x86_64.AppImage" ]; then
            cp LinguaGPT-${VERSION}-x86_64.AppImage LinguaGPT.AppImage
            chmod +x LinguaGPT.AppImage
            echo "âœ“ AppImage created successfully"
          fi

          # ========================================
          # 5. Flatpak manifest (for Flathub)
          # ========================================
          echo "=== Creating Flatpak manifest ==="
          mkdir -p packaging/flatpak

          cat > packaging/flatpak/com.linguagpt.LinguaGPT.yml << EOFFLATPAK
          app-id: com.linguagpt.LinguaGPT
          runtime: org.kde.Platform
          runtime-version: '6.6'
          sdk: org.kde.Sdk
          command: LinguaGPT
          finish-args:
            - --share=ipc
            - --socket=x11
            - --socket=wayland
            - --device=dri
            - --share=network
          modules:
            - name: linguagpt
              buildsystem: simple
              build-commands:
                - install -Dm755 LinguaGPT /app/bin/LinguaGPT
                - install -Dm644 linguagpt.desktop /app/share/applications/com.linguagpt.LinguaGPT.desktop
                - install -Dm644 linguagpt.png /app/share/icons/hicolor/256x256/apps/com.linguagpt.LinguaGPT.png
              sources:
                - type: file
                  path: LinguaGPT
                - type: file
                  path: linguagpt.desktop
                - type: file
                  path: linguagpt.png
          EOFFLATPAK

          cp dist/LinguaGPT packaging/flatpak/
          cp linguagpt-icon.png packaging/flatpak/linguagpt.png

          cat > packaging/flatpak/linguagpt.desktop << EOFDESKTOP
          [Desktop Entry]
          Name=LinguaGPT
          Comment=AI-powered translation tool
          Exec=LinguaGPT
          Icon=com.linguagpt.LinguaGPT
          Terminal=false
          Type=Application
          Categories=Utility;Office;Translation;
          EOFDESKTOP

          tar czf flatpak-manifest-${VERSION}.tar.gz -C packaging flatpak/

          # ========================================
          # 6. Snap package manifest
          # ========================================
          echo "=== Creating Snap manifest ==="
          mkdir -p packaging/snap

          cat > packaging/snap/snapcraft.yaml << EOFSNAP
          name: linguagpt
          version: '${VERSION}'
          summary: AI-powered translation tool
          description: |
            LinguaGPT is a modern translation application powered by GPT models.
            It provides high-quality translations using OpenAI's API.

          base: core22
          confinement: strict
          grade: stable

          apps:
            linguagpt:
              command: bin/LinguaGPT
              plugs:
                - desktop
                - desktop-legacy
                - wayland
                - x11
                - network
                - home

          parts:
            linguagpt:
              plugin: dump
              source: .
              organize:
                LinguaGPT: bin/LinguaGPT
          EOFSNAP

          cp dist/LinguaGPT packaging/snap/
          tar czf snap-manifest-${VERSION}.tar.gz -C packaging snap/

          # ========================================
          # 7. Standalone tarball
          # ========================================
          echo "=== Creating standalone tarball ==="
          mkdir -p linguagpt-${VERSION}-linux-x86_64
          cp dist/LinguaGPT linguagpt-${VERSION}-linux-x86_64/
          chmod +x linguagpt-${VERSION}-linux-x86_64/LinguaGPT

          cat > linguagpt-${VERSION}-linux-x86_64/README.txt << EOFREADME
          # LinguaGPT v${VERSION}

          ## Quick Start:
          ./LinguaGPT

          ## System Requirements:
          - Qt6 libraries
          - glibc 2.31+

          ## Installation (optional):
          sudo cp LinguaGPT /usr/local/bin/
          EOFREADME

          tar czf linguagpt-${VERSION}-linux-x86_64.tar.gz linguagpt-${VERSION}-linux-x86_64/

          echo "=== Package creation complete ==="
          ls -lh *.deb *.rpm *.AppImage *.tar.gz 2>/dev/null || true

      - name: Package macOS
        if: runner.os == 'macOS'
        run: |
          VERSION="${GITHUB_REF#refs/tags/v}"

          brew install create-dmg 2>/dev/null || true

          if command -v create-dmg &> /dev/null; then
            create-dmg \
              --volname "LinguaGPT" \
              --volicon "dist/LinguaGPT.app/Contents/Resources/icon.icns" \
              --window-pos 200 120 \
              --window-size 600 400 \
              --icon-size 100 \
              --icon "LinguaGPT.app" 175 120 \
              --hide-extension "LinguaGPT.app" \
              --app-drop-link 425 120 \
              "LinguaGPT-${VERSION}.dmg" \
              "dist/LinguaGPT.app" || \
            hdiutil create -volname "LinguaGPT" \
              -srcfolder "dist/LinguaGPT.app" \
              -ov -format UDZO \
              "LinguaGPT-${VERSION}.dmg"
          else
            hdiutil create -volname "LinguaGPT" \
              -srcfolder "dist/LinguaGPT.app" \
              -ov -format UDZO \
              "LinguaGPT-${VERSION}.dmg"
          fi

          cd dist
          zip -r ../LinguaGPT.app.zip LinguaGPT.app
          cd ..

      - name: Package Windows
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          Compress-Archive -Path "dist\LinguaGPT.exe" -DestinationPath "LinguaGPT.exe.zip" -Force
          Copy-Item "dist\LinguaGPT.exe" -Destination "LinguaGPT.exe"

          $innoSetup = "C:\Program Files (x86)\Inno Setup 6\ISCC.exe"
          if (Test-Path $innoSetup) {
            $version = $env:GITHUB_REF -replace 'refs/tags/v', ''

            @"
          [Setup]
          AppName=LinguaGPT
          AppVersion=$version
          DefaultDirName={pf}\LinguaGPT
          DefaultGroupName=LinguaGPT
          OutputDir=.
          OutputBaseFilename=LinguaGPT-Setup-$version
          Compression=lzma2
          SolidCompression=yes

          [Files]
          Source: "dist\LinguaGPT.exe"; DestDir: "{app}"

          [Icons]
          Name: "{group}\LinguaGPT"; Filename: "{app}\LinguaGPT.exe"
          Name: "{commondesktop}\LinguaGPT"; Filename: "{app}\LinguaGPT.exe"
          "@ | Out-File -FilePath "installer.iss" -Encoding UTF8

            & $innoSetup "installer.iss"
          }

      # ===== UPLOAD ARTIFACTS =====

      - name: Upload Linux artifacts
        if: runner.os == 'Linux'
        uses: actions/upload-artifact@v4
        with:
          name: linux-artifacts
          path: |
            linguagpt_*_amd64.deb
            linguagpt-*-1.*.x86_64.rpm
            linguagpt-arch-*.tar.gz
            LinguaGPT.AppImage
            linguagpt-*-linux-x86_64.tar.gz
            flatpak-manifest-*.tar.gz
            snap-manifest-*.tar.gz
          retention-days: 7

      - name: Upload macOS artifacts
        if: runner.os == 'macOS'
        uses: actions/upload-artifact@v4
        with:
          name: macos-artifacts
          path: |
            LinguaGPT-*.dmg
            LinguaGPT.app.zip
          retention-days: 7

      - name: Upload Windows artifacts
        if: runner.os == 'Windows'
        uses: actions/upload-artifact@v4
        with:
          name: windows-artifacts
          path: |
            LinguaGPT.exe
            LinguaGPT.exe.zip
            LinguaGPT-Setup-*.exe
          retention-days: 7

  release:
    name: Create Release
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Extract version from tag
        id: get_version
        run: |
          VERSION="${GITHUB_REF#refs/tags/v}"
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Extracted version: $VERSION"

      - name: List all downloaded files
        run: |
          echo "=== All downloaded artifacts ==="
          find artifacts -type f -ls

      - name: Prepare release files
        run: |
          mkdir -p release

          echo "=== Copying Linux files ==="
          find artifacts/linux-artifacts -type f -exec cp {} release/ \;

          echo "=== Copying macOS files ==="
          find artifacts/macos-artifacts -type f -exec cp {} release/ \;

          echo "=== Copying Windows files ==="
          find artifacts/windows-artifacts -type f -exec cp {} release/ \;

          echo "=== Final release files ==="
          ls -lah release/

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: release/*
          name: LinguaGPT v${{ steps.get_version.outputs.version }}
          body: |
            ## ðŸ“¦ Downloads

            ### Windows
            - `LinguaGPT-Setup-*.exe` - Windows Installer (recommended)
            - `LinguaGPT.exe` - Portable executable
            - `LinguaGPT.exe.zip` - Portable ZIP archive

            ### macOS
            - `LinguaGPT-*.dmg` - macOS Disk Image (recommended)
            - `LinguaGPT.app.zip` - App Bundle ZIP

            ### Linux

            #### Universal (All Distros)
            - `LinguaGPT.AppImage` - Universal AppImage (recommended for most users)
            - `linguagpt-*-linux-x86_64.tar.gz` - Standalone tarball

            #### Debian/Ubuntu/Linux Mint
            ```bash
            sudo dpkg -i linguagpt_*_amd64.deb
            sudo apt-get install -f
            ```

            #### Fedora/RHEL/CentOS/Rocky Linux
            ```bash
            sudo dnf install linguagpt-*-1.*.x86_64.rpm
            # or for older versions
            sudo yum install linguagpt-*-1.*.x86_64.rpm
            ```

            #### Arch Linux/Manjaro
            ```bash
            # Extract and install
            tar xzf linguagpt-arch-*.tar.gz
            cd linguagpt-arch-*
            makepkg -si
            ```

            #### Flatpak (Any distro)
            ```bash
            # Extract manifest and build
            tar xzf flatpak-manifest-*.tar.gz
            cd flatpak
            flatpak-builder build com.linguagpt.LinguaGPT.yml
            ```

            #### Snap (Any distro)
            ```bash
            # Extract and build
            tar xzf snap-manifest-*.tar.gz
            cd snap
            snapcraft
            sudo snap install linguagpt_*.snap --dangerous
            ```
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
